# 实验报告4

### 任务要求一览：

任务一：用bash编写一个图片批处理脚本，实现以下功能：

- [x] 支持命令行参数方式使用不同功能
- [x] 支持对指定目录下所有支持格式的图片文件进行批处理
- [x] 支持以下常见图片批处理功能的单独使用或组合使用
  - [x] 支持对jpeg格式图片进行图片质量压缩
  - [x] 支持对jpeg/png/svg格式图片在保持原始宽高比的前提下压缩分辨率
  - [x] 支持对图片批量添加自定义文本水印
  - [x] 支持批量重命名（统一添加文件名前缀或后缀，不影响原始文件扩展名）
  - [x] 支持将png/svg图片统一转换为jpg格式图片

任务二：用bash编写一个文本批处理脚本，对以下附件分别进行批量处理完成相应的数据统计任务：

- 2014世界杯运动员数据
  - [x] 统计不同年龄区间范围（20岁以下、[20-30]、30岁以上）的球员**数量**、**百分比**
  - [x] 统计不同场上位置的球员**数量**、**百分比**
  - [x] 名字最长的球员是谁？名字最短的球员是谁？
  - [x] 年龄最大的球员是谁？年龄最小的球员是谁？

任务三：用bash编写一个文本批处理脚本，对以下附件分别进行批量处理完成相应的数据统计任务：

- Web服务器访问日志
  - [x] 统计访问来源主机TOP 100和分别对应出现的总次数
  - [x] 统计访问来源主机TOP 100 IP和分别对应出现的总次数
  - [x] 统计最频繁被访问的URL TOP 100
  - [x] 统计不同响应状态码的出现次数和对应百分比
  - [x] 分别统计不同4XX状态码对应的TOP 10 URL和对应出现的总次数
  - [x] 给定URL输出TOP 100访问来源主机

## 具体过程

### 任务一

​		实验环境：安装`imagemagick`，利用winscp上传图片文件

![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\upload.bmp)

支持命令行参数方式使用不同功能，编写帮助文档

```bash
function help {
    echo "doc"
    echo "-q Q               对jpeg格式图片进行图片质量因子为Q的压缩"
    echo "-w W               对jpeg/png/svg格式图片在保持原始宽高比的前提下压缩成R分辨率"
    echo "-r font_size text  对图片批量添加自定义文本水印"
    echo "-t text            统一添加文件名前缀，不影响原始文件扩展名"
    echo "-a text            统一添加文件名后缀，不影响原始文件扩展名"
    echo "-s                 将png/svg图片统一转换为jpg格式图片"
    echo "-h                 帮助文档"
}
```

- 支持对jpeg格式图片进行图片质量压缩

- ```bash
  function CompressQuality {
      qua=$1 
      for i in *;do
          type=${i##*.} 
          if [[ ${type} != "jpeg" ]]; then continue; fi;
          convert "${i}" -quality "${qua}" "${i}"
          echo "${i} is compressed."
      done
  }
  ```

- 结果：

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\code_1.bmp)

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\result_1.bmp)

- 支持对jpeg/png/svg格式图片在保持原始宽高比的前提下压缩分辨率

  ```bash
  function CompressResolution {
      res=$1
      for i in *;do
          type=${i##*.}
          if [[ ${type} != "jpeg" && ${type} != "png" && ${type} != "svg" ]]; then continue; fi;
          convert "${i}" -resize "${res}" "${i}"
          echo "${i} is resized."
      done
  }
  ```

- 结果：

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\code_2.png)

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\result_2.bmp)

  > 在压缩svg图像时出现报错：convert-im6.q16: non-conforminnng drawing primintive definition，查询资料显示，改正方法为run：
  >
  > sudo apt-get install ghostscript          
  >
  > sudo apt-get install fonts-freefont-otf

- 支持对图片批量添加自定义文本水印

  ```bash
  function print {
      for i in *;do
          type=${i##*.}
          if [[ ${type} != "jpeg" && ${type} != "png" && ${type} != "svg" ]]; then continue; fi;
          convert "${i}" -pointsize "$1" -fill black -gravity center -draw "text 10,10 '$2'" "${i}"
          echo "${i} is watermarked with $2."
      done
  }
  ```

- 结果：

- ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\code_3.png)

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\result_3.bmp)

- 支持批量重命名（统一添加文件名前缀或后缀，不影响原始文件扩展名）

  ```bash
  # 批量重命名（统一添加文件名前缀或后缀，不影响原始文件扩展名）
  function pre {
      for i in *;do
          type=${i##*.}
          if [[ ${type} != "jpeg" && ${type} != "png" && ${type} != "svg" ]]; then continue; fi;
          re "${i}" "$1""${i}"
          echo "${i} is renamed to $1${i}"
      done
  }
  
  function aft {
      for i in *;do
          type=${i##*.}
          if [[ ${type} != "jpeg" && ${type} != "png" && ${type} != "svg" ]]; then continue; fi;
          filename=${i%.*}$1"."${type}
          re "${i}" "${filename}"
          echo "${i} is renamed to ${filename}"
      done
  }
  ```

- 结果：

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\code_4.png)

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\result_4.png)

- 支持将png/svg图片统一转换为jpg格式图片

  ```bash
  function transfor_jpg {
      for i in *;do
          type=${i##*.}
          if [[ ${type} != "png" && ${type} != "svg" ]]; then continue; fi;
          filename=${i%.*}".jpg"
          convert "${i}" "${filename}"
     	echo "${i} is transformed to ${filename}"
      done
  }
  ```

- 结果：

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\code_5.png)

  ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\result_5.bmp)

### 任务二

- 准备：

  1. 同样通过winscp将文件download到系统中

     ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\load.png)

  2. 编写帮助文档

     ```bash
     function help {
         echo "doc"
         echo "-a                 统计不同年龄区间范围（20岁以下、[20-30]、30岁以上）的球员数量、百分比"
         echo "-b                 统计不同场上位置的球员数量、百分比"
         echo "-c                 名字最长的球员是谁？名字最短的球员是谁？"
         echo "-d                 年龄最大的球员是谁？年龄最小的球员是谁？"
         echo "-h                 帮助文档"
     }
     ```

     3. 点开数据库观察属性名

        ![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第四次实验\img\data.png)

- 统计不同年龄区间范围（20岁以下、[20-30]、30岁以上）的球员**数量**、**百分比**

  ```bash
  function Age_board {
      awk -F "\t" '
          BEGIN {a=0; b=0; c=0;}
          $6!="Age" {
              if($6>=0&&$6<20) {a++;}
              else if($6<=30) {b++;}
              else {c++;}
          }
          END {
              sum=a+b+c;
             
              printf("num<20 %d  %f%%\n",a,a*100.0/sum);
              printf("num between[20,30] %d  %f%%\n",b,b*100.0/sum);
              printf("num>30 %d  %f%%\n",c,c*100.0/sum);
              
          }' worldcupplayerinfo.tsv
  }	
  ```

  

- 统计不同场上位置的球员**数量**、**百分比**

  ```bash
  function position {
      awk -F "\t" '
          BEGIN {sum=0}
          $5!="Position" {
              pos[$5]++;
              sum++;
          }
          END {
              for(i in pos) {
                  printf("%13s %d %f%%\n",i,pos[i],pos[i]*100.0/sum);
              }
          }' worldcupplayerinfo.tsv
  }
  ```

  

- 名字最长的球员是谁？名字最短的球员是谁？

  ```bash
  function maxName {
      awk -F "\t" '
          BEGIN {max=-1; min=1000;}
          $9!="Player" {
              len=length($9);
              names[$9]=len;
              max=len>max?len:max;
              min=len<min?len:min;
          }
          END {
              for(i in names) {
                  if(names[i]==max) {
                      printf("The longest : %s\n", i);
                  } else  if(names[i]==min) {
                      printf("The shortest : s\n", i);
                  }
              }
          }' worldcupplayerinfo.tsv
  }
  ```

  

- 年龄最大的球员是谁？年龄最小的球员是谁？

  ```bash
  function maxAge {
      awk -F "\t" '
          BEGIN {max=-1; min=1000;}
          NR>1 {
              age=$6;
              names[$9]=age;
              max=age>max?age:max;
              min=age<min?age:min;
          }
          END {
              printf("The oldest age is %d, who is\n", max);
              for(i in names) {
                  if(names[i]==max) { printf("%s\n", i); }
              }
              printf("The youngest age is %d, who is\n", min);
              for(i in names) {
                  if(names[i]==min) { printf("%s\n", i); }
              }
          }' worldcupplayerinfo.tsv
  }
  ```

### 任务三

- 准备：

  - 下载p7zip-full和文件

  - 帮助文档

    ```bash
    function help {
        echo "doc"
        echo "-a      统计访问来源主机TOP 100和分别对应出现的总次数"
        echo "-b      统计访问来源主机TOP 100 IP和分别对应出现的总次数"
        echo "-c      统计最频繁被访问的URL TOP 100"
        echo "-d      统计不同响应状态码的出现次数和对应百分比"
        echo "-e      分别统计不同4XX状态码对应的TOP 10 URL和对应出现的总次数"
        echo "-f      给定URL输出TOP 100访问来源主机"
        echo "-h      帮助文档"
    }
    ```

- 统计访问来源主机TOP 100和分别对应出现的总次数

  ```bash
  #sort进行初次排序，为的使相同的记录排列到一起；
  #head进行前十名筛选；
  
  function times {
      awk -F "\t" '
      NR>1 {host[$1]++;}
      
      END {
      	for(i in host) {
      	printf("%40s  %d\n",i,host[i]);
      		}
          		}' web_log.tsv | sort -g -k 2 -r | head -100
  }
  ```

- 统计访问来源主机TOP 100 IP和分别对应出现的总次数

  ```bash
  function ip {
      awk -F "\t" '
      NR>1 {
      if(match($1, /^[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}$/))
      	ip[$1]++;
      		}
      	
      END {
      	for(i in ip){
      		printf("%20s  %d\n",i,ip[i]);
      				} 
      					}' web_log.tsv | sort -g -k 2 -r | head -100
  }
  ```

- 统计最频繁被访问的URL TOP 100

  ```bash
  function urls {
      awk -F "\t" '
      NR>1 {url[$5]++;}
      
      END { 
      for(i in url) {
      	printf("%55s  %d\n",i,url[i]);
      		}
              	}' web_log.tsv | sort -g -k 2 -r | head -100
  }
  ```

- 统计不同响应状态码的出现次数和对应百分比

  ```bash
  function code_times {
      awk -F "\t" '
      BEGIN {
      printf("code\tcount\tpercentage\n");
      }
      NR>1{code[$6]++;}
      
      END {for(i in code){
      printf("%d %d %f%%\n",i,code[i],100.0*code[i]/(NR-1));
      	}
      		}' web_log.tsv
  }
  ```

- 分别统计不同4XX状态码对应的TOP 10 URL和对应出现的总次数

  ```bash
  function code_time4 {
      awk -F "\t" '
      NR>1 { 
    	  if($6=="403")
      		code[$5]++;
      		}
      END { 
      	for(i in code) 
      		{printf("%55s\t%d\n",i,code[i]);
      		}
              	}' web_log.tsv | sort -g -k 2 -r | head -10
      awk -F "\t" '
     
     NR>1 {
     		if($6=="404")
          code[$5]++;
          	}
      
      END {
      	for(i in code) {
      		printf("%55s\t%d\n",i,code[i]);;
      		} 
      			} ' web_log.tsv | sort -g -k 2 -r | head -10
  }
  ```

- 给定URL输出TOP 100访问来源主机

  ```bash
  function url_named {
      awk -F "\t" '
      NR>1 {
      	if("'"$1"'"==$5) {
      		host[$1]++;
      				}
              			}
      END { 
      	for(i in host) {
      		printf("%40s  %d\n",i,host[i]);
      				}
              			}' web_log.tsv | sort -g -k 2 -r | head -100
  }
  ```

  > 参考资料：
  >
  > [Linux系统与网络管理 (c4pr1c3.github.io)](https://c4pr1c3.github.io/LinuxSysAdmin/chap0x04.md.html#/6/1)
  >
  > [web服务器日志里面访问次数最多的IP_魏建发技术博客的技术博客_51CTO博客](https://blog.51cto.com/u_12832314/2352192)
  >
  > [(28条消息) Web服务器日志统计分析完全解决方案_snowman_sp的博客-CSDN博客](https://blog.csdn.net/snowman_sp/article/details/560877)
  >
  > [(28条消息) shell多进程处理多图像_Little_sky_jty的博客-CSDN博客](https://blog.csdn.net/weixin_40805392/article/details/104792874)
  >
  > [2022-linux-public-Xuyan-cmd/chap0×04.md at chap0×04 · CUCCS/2022-linux-public-Xuyan-cmd (github.com)](https://github.com/CUCCS/2022-linux-public-Xuyan-cmd/blob/chap0×04/chap0x04/chap0×04.md)



