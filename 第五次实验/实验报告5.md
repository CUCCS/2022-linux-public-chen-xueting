
# 第五次实验

### 实验环境

- 虚拟机：Virtualbox
  Ubuntu 20.04 Server 64bit
- 软件环境：
  - VScode编译器
  - Nginx
  - VeryNginx
  - WordCompress 4.7

### 基本要求

- 在一台主机（虚拟机）上同时配置Nginx和VeryNginx
  - VeryNginx作为本次实验的Web App的反向代理服务器和WAF
  - PHP-FPM进程的反向代理配置在nginx服务器上，VeryNginx服务器不直接配置Web站点服务
- 使用[Wordpress](https://wordpress.org/)搭建的站点对外提供访问的地址为： http://wp.sec.cuc.edu.cn
- 使用[Damn Vulnerable Web Application (DVWA)](http://www.dvwa.co.uk/)搭建的站点对外提供访问的地址为： http://dvwa.sec.cuc.edu.cn

### 安全加固要求

- 使用IP地址方式均无法访问上述任意站点，并向访客展示自定义的**友好错误提示信息页面-1**
- [Damn Vulnerable Web Application (DVWA)](http://www.dvwa.co.uk/)只允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的**友好错误提示信息页面-2**
- 在不升级Wordpress版本的情况下，通过定制[VeryNginx](https://github.com/alexazhou/VeryNginx)的访问控制策略规则，**热**修复[WordPress < 4.7.1 - Username Enumeration](https://www.exploit-db.com/exploits/41497/)
- 通过配置[VeryNginx](https://github.com/alexazhou/VeryNginx)的Filter规则实现对[Damn Vulnerable Web Application (DVWA)](http://www.dvwa.co.uk/)的SQL注入实验在低安全等级条件下进行防护

### VeryNginx配置要求

- [VeryNginx](https://github.com/alexazhou/VeryNginx)的Web管理页面仅允许白名单上的访客来源IP，其他来源的IP访问均向访客展示自定义的**友好错误提示信息页面-3**

- 通过定制

  VeryNginx

  的访问控制策略规则实现：

  - 限制DVWA站点的单IP访问速率为每秒请求数 < 50
  - 限制Wordpress站点的单IP访问速率为每秒请求数 < 20
  - 超过访问频率限制的请求直接返回自定义**错误提示信息页面-4**
  - 禁止curl访问

### 实验过程

***

1. 环境搭建

   1. 更改主机hosts文件

   ```bash
   192.168.56.101 vn.sec.cuc.edu.cn
   192.168.56.101 dvwa.sec.cuc.edu.cn
   192.168.56.101 wp.sec.cuc.edu.cn
   ```

![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第五次实验\img\host.png)

2.安装

```bash
#nginx
sudo apt update
sudo apt install nginx

#PHP
sudo apt install php-fpm php-mysql php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip

#MySQL
sudo apt install mysql-server

# VeryNginx(这里需要先安装一些缺少的库)
sudo apt install zlib1g-dev
sudo apt install libpcre3 libpcre3-dev
sudo apt install gcc
sudo apt install make
sudo apt install libssl-dev

sudo git clone https://github.com/alexazhou/VeryNginx.git、
#进入VeryNginx目录
cd VeryNginx
sudo python3 install.py install
```

3.修改配置文件

```bash
 sudo vim /opt/verynginx/openresty/nginx/conf/nginx.conf

 #修改用户名
 user www-data;
 
 server {
 		#修改端口号
        listen  192.168.56.101:80;

        #this line shoud be include in every server block
        include /opt/verynginx/verynginx/nginx_conf/in_server_block.conf;

        location = / {
            root html;
            index  index.html index.htm;
        }
    }
}
#：wq退出vim模式
```

4.网页连接

```
# 启动，此时会出现报错，经检查是端口占用
#需要用 切换到root用户，netstat apn | grep 80检查端口杀死进程，然而卑微的是我发现一直杀不死，仔细观察才发现，原来是因为cache2的端口也是80，所以我又得把那玩意改成其它的才行，感谢上帝我弄出来了
sudo /opt/verynginx/openresty/nginx/sbin/nginx
```

![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第五次实验\img\kill.png)

![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第五次实验\img\感谢上帝.png)

5.安装WordPress

```bash
# 下载安装包
sudo wget https://wordpress.org/wordpress-4.7.zip

# 解压
7z x wordpress-4.7.zip

# 将解压后的wordpress移到指定路径
sudo mkdir /var/www/html/wp.sec.cuc.edu.cn
sudo cp -r wordpress /var/www/html/wp.sec.cuc.edu.cn
```

6.MySQL用户创建

```bash
#建库
sudo apt install mysql-server
sudo mysql

CREATE DATABASE wordpress DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
create user 'nancy'@'localhost' identified by 'cuc';

grant all on wordpress.* to 'sylvia'@'localhost';
flush privileges;

exit

#配置
cd /var/www/html/wp.sec.cuc.edu.cn/wordpress
sudo vim wp-config-sample.php
sudo mv wp-config-sample.php wp-config.php
sudo vim /etc/php/7.4/fpm/php.ini 
```

7.DVWA

```BASH
# 下载
git clone https://github.com/digininja/DVWA.git
# 建立目录
sudo mkdir /var/www/html/dvwa.sec.cuc.edu.cn
# 把文件夹里面的内容移动到目录下
sudo mv DVWA/* /var/www/html/dvwa.sec.cuc.edu.cn
# 修改权限
display_errors: Disabled
safe_mode: Disabled
allow_url_include: Enabled
allow_url_fopen: Enabled

#重启php
systemctl restart php7.4-fpm.service
#将所有权分配给www-data用户和组
sudo chown -R www-data.www-data /var/www/html/dvwa.sec.cuc.edu.cn

#进入vim配置

listen 8002 default_server;
try_files $uri $uri/ /index.php$is_args$args;  
root /var/www/html/dvwa.sec.cuc.edu.cn;
server_name dvwa.sec.cuc.edu.cn;
index index.php index.html index.htm index.nginx-debian.html;

# 新建符号链接

sudo ln -s /etc/nginx/sites-available/dvwa.sec.cuc.edu.cn /etc/nginx/sites-enabled/

# 测试并重启Nginx服务
sudo nginx -t
systemctl restart nginx.service
```

![](C:\Users\LENOVO\Desktop\2022-linux-public-chen-xueting\第五次实验\img\DVWA.png)

### 参考资料

***

[开始使用 VeryNginx-蒲公英云 (dandelioncloud.cn)](https://dandelioncloud.cn/article/details/1392446994299039745)

https://github.com/alexazhou/VeryNginx/blob/master/readme_zh.md

http://courses.cuc.edu.cn/course/82669/forum?show_sidebar=false#/topics/290623
